const sqlite3 = require('sqlite3').verbose();
const bcrypt = require('bcrypt');
const path = require('path');

// Database dosyasƒ± yolu - Production'da /tmp kullan
const dbPath = process.env.NODE_ENV === 'production' 
    ? '/tmp/tedarik.db' 
    : path.join(__dirname, '../database/tedarik.db');

console.log('üóÑÔ∏è  TEDARƒ∞K Zƒ∞NCƒ∞Rƒ∞ VERƒ∞TABANI KURULUMU BA≈ûLIYOR...\n');

const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('‚ùå Veritabanƒ± baƒülantƒ± hatasƒ±:', err.message);
        return;
    }
    console.log('‚úÖ SQLite veritabanƒ±na baƒülanƒ±ldƒ±:', dbPath);
});

// Tablolarƒ± olu≈ütur
db.serialize(() => {
    
    // 1. USERS Tablosu (Admin + Tedarik√ßiler)
    db.run(`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        role TEXT NOT NULL CHECK(role IN ('admin', 'supplier')),
        is_active INTEGER DEFAULT 1,
        email_verified INTEGER DEFAULT 0,
        last_login DATETIME,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`, (err) => {
        if (err) console.error('‚ùå users tablosu:', err.message);
        else console.log('‚úÖ users tablosu olu≈üturuldu');
    });

    // 2. SUPPLIERS Tablosu (Tedarik√ßi Profilleri)
    db.run(`CREATE TABLE IF NOT EXISTS suppliers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER UNIQUE NOT NULL,
        company_name TEXT NOT NULL,
        tax_number TEXT,
        contact_person TEXT,
        phone TEXT,
        address TEXT,
        city TEXT,
        country TEXT DEFAULT 'T√ºrkiye',
        categories TEXT, -- JSON array
        rating REAL DEFAULT 0.0,
        total_quotations INTEGER DEFAULT 0,
        successful_quotations INTEGER DEFAULT 0,
        is_approved INTEGER DEFAULT 0,
        approval_date DATETIME,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    )`, (err) => {
        if (err) console.error('‚ùå suppliers tablosu:', err.message);
        else console.log('‚úÖ suppliers tablosu olu≈üturuldu');
    });

    // 3. REQUESTS Tablosu (Talep Listesi)
    db.run(`CREATE TABLE IF NOT EXISTS requests (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        request_no TEXT UNIQUE NOT NULL,
        title TEXT NOT NULL,
        description TEXT,
        deadline DATETIME,
        status TEXT DEFAULT 'active' CHECK(status IN ('active', 'closed', 'cancelled', 'draft')),
        priority TEXT DEFAULT 'normal' CHECK(priority IN ('low', 'normal', 'high', 'urgent')),
        created_by INTEGER NOT NULL,
        total_items INTEGER DEFAULT 0,
        total_suppliers INTEGER DEFAULT 0,
        received_quotations INTEGER DEFAULT 0,
        winner_supplier_id INTEGER,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (created_by) REFERENCES users (id),
        FOREIGN KEY (winner_supplier_id) REFERENCES suppliers (id)
    )`, (err) => {
        if (err) console.error('‚ùå requests tablosu:', err.message);
        else console.log('‚úÖ requests tablosu olu≈üturuldu');
    });

    // 4. REQUEST_ITEMS Tablosu (Talep Malzemeleri)
    db.run(`CREATE TABLE IF NOT EXISTS request_items (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        request_id INTEGER NOT NULL,
        item_no INTEGER NOT NULL,
        material_code TEXT,
        material_name TEXT NOT NULL,
        quantity REAL NOT NULL,
        unit TEXT NOT NULL,
        specifications TEXT,
        category TEXT,
        priority TEXT DEFAULT 'normal',
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (request_id) REFERENCES requests (id) ON DELETE CASCADE
    )`, (err) => {
        if (err) console.error('‚ùå request_items tablosu:', err.message);
        else console.log('‚úÖ request_items tablosu olu≈üturuldu');
    });

    // 5. REQUEST_SUPPLIERS Tablosu (Talebin g√∂nderildiƒüi tedarik√ßiler)
    db.run(`CREATE TABLE IF NOT EXISTS request_suppliers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        request_id INTEGER NOT NULL,
        supplier_id INTEGER NOT NULL,
        invitation_sent INTEGER DEFAULT 0,
        invitation_date DATETIME,
        response_received INTEGER DEFAULT 0,
        response_date DATETIME,
        status TEXT DEFAULT 'invited' CHECK(status IN ('invited', 'viewed', 'quoted', 'declined')),
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (request_id) REFERENCES requests (id) ON DELETE CASCADE,
        FOREIGN KEY (supplier_id) REFERENCES suppliers (id),
        UNIQUE(request_id, supplier_id)
    )`, (err) => {
        if (err) console.error('‚ùå request_suppliers tablosu:', err.message);
        else console.log('‚úÖ request_suppliers tablosu olu≈üturuldu');
    });

    // 6. QUOTATIONS Tablosu (Teklifler)
    db.run(`CREATE TABLE IF NOT EXISTS quotations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        quotation_no TEXT UNIQUE NOT NULL,
        request_id INTEGER NOT NULL,
        supplier_id INTEGER NOT NULL,
        total_amount REAL DEFAULT 0,
        currency TEXT DEFAULT 'TRY',
        delivery_time INTEGER, -- g√ºn
        delivery_location TEXT,
        validity_days INTEGER DEFAULT 30,
        payment_terms TEXT,
        status TEXT DEFAULT 'draft' CHECK(status IN ('draft', 'submitted', 'accepted', 'rejected', 'expired')),
        submission_date DATETIME,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (request_id) REFERENCES requests (id) ON DELETE CASCADE,
        FOREIGN KEY (supplier_id) REFERENCES suppliers (id),
        UNIQUE(request_id, supplier_id)
    )`, (err) => {
        if (err) console.error('‚ùå quotations tablosu:', err.message);
        else console.log('‚úÖ quotations tablosu olu≈üturuldu');
    });

    // 7. QUOTATION_ITEMS Tablosu (Teklif Malzemeleri)
    db.run(`CREATE TABLE IF NOT EXISTS quotation_items (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        quotation_id INTEGER NOT NULL,
        request_item_id INTEGER NOT NULL,
        unit_price REAL NOT NULL,
        total_price REAL NOT NULL,
        delivery_time INTEGER, -- g√ºn
        brand TEXT,
        model TEXT,
        origin_country TEXT,
        warranty_period TEXT,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (quotation_id) REFERENCES quotations (id) ON DELETE CASCADE,
        FOREIGN KEY (request_item_id) REFERENCES request_items (id),
        UNIQUE(quotation_id, request_item_id)
    )`, (err) => {
        if (err) console.error('‚ùå quotation_items tablosu:', err.message);
        else console.log('‚úÖ quotation_items tablosu olu≈üturuldu');
    });

    // 8. CATEGORIES Tablosu (Malzeme Kategorileri)
    db.run(`CREATE TABLE IF NOT EXISTS categories (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        description TEXT,
        parent_id INTEGER,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (parent_id) REFERENCES categories (id)
    )`, (err) => {
        if (err) console.error('‚ùå categories tablosu:', err.message);
        else console.log('‚úÖ categories tablosu olu≈üturuldu');
    });

    // 9. NOTIFICATIONS Tablosu (Bildirimler)
    db.run(`CREATE TABLE IF NOT EXISTS notifications (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        type TEXT NOT NULL CHECK(type IN ('request', 'quotation', 'deadline', 'approval', 'system')),
        title TEXT NOT NULL,
        message TEXT NOT NULL,
        data TEXT, -- JSON data
        is_read INTEGER DEFAULT 0,
        is_email_sent INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    )`, (err) => {
        if (err) console.error('‚ùå notifications tablosu:', err.message);
        else console.log('‚úÖ notifications tablosu olu≈üturuldu');
    });

    // 10. FILES Tablosu (Dosya Y√ºklemeleri)
    db.run(`CREATE TABLE IF NOT EXISTS files (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        filename TEXT NOT NULL,
        original_name TEXT NOT NULL,
        file_path TEXT NOT NULL,
        file_size INTEGER,
        mime_type TEXT,
        uploaded_by INTEGER NOT NULL,
        related_type TEXT CHECK(related_type IN ('request', 'quotation', 'supplier')),
        related_id INTEGER,
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (uploaded_by) REFERENCES users (id)
    )`, (err) => {
        if (err) console.error('‚ùå files tablosu:', err.message);
        else console.log('‚úÖ files tablosu olu≈üturuldu');
    });

    // 11. SETTINGS Tablosu (Sistem Ayarlarƒ±)
    db.run(`CREATE TABLE IF NOT EXISTS settings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        key TEXT UNIQUE NOT NULL,
        value TEXT NOT NULL,
        description TEXT,
        type TEXT DEFAULT 'string' CHECK(type IN ('string', 'number', 'boolean', 'json')),
        updated_by INTEGER,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (updated_by) REFERENCES users (id)
    )`, (err) => {
        if (err) console.error('‚ùå settings tablosu:', err.message);
        else console.log('‚úÖ settings tablosu olu≈üturuldu');
    });

    // 12. AUDIT_LOGS Tablosu (ƒ∞≈ülem Ge√ßmi≈üi)
    db.run(`CREATE TABLE IF NOT EXISTS audit_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        action TEXT NOT NULL,
        table_name TEXT,
        record_id INTEGER,
        old_values TEXT, -- JSON
        new_values TEXT, -- JSON
        ip_address TEXT,
        user_agent TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (id)
    )`, (err) => {
        if (err) console.error('‚ùå audit_logs tablosu:', err.message);
        else console.log('‚úÖ audit_logs tablosu olu≈üturuldu');
    });

    // BA≈ûLANGI√á VERƒ∞LERƒ∞Nƒ∞ EKLE
    setTimeout(() => {
        insertInitialData();
    }, 1000);
});

function insertInitialData() {
    console.log('\nüìä BA≈ûLANGI√á VERƒ∞LERƒ∞ EKLENƒ∞YOR...\n');
    
    // Admin kullanƒ±cƒ± olu≈ütur
    const adminPassword = bcrypt.hashSync('admin123', 12);
    
    db.run(`INSERT OR IGNORE INTO users (username, email, password_hash, role, is_active, email_verified) 
            VALUES (?, ?, ?, ?, ?, ?)`, 
        ['admin', 'admin@tmitek.com', adminPassword, 'admin', 1, 1], 
        function(err) {
            if (err) console.error('‚ùå Admin kullanƒ±cƒ±:', err.message);
            else console.log('‚úÖ Admin kullanƒ±cƒ± olu≈üturuldu (admin/admin123)');
        }
    );

    // Test tedarik√ßi kullanƒ±cƒ±larƒ±
    const supplierPassword = bcrypt.hashSync('supplier123', 12);
    
    const testSuppliers = [
        {username: 'demirtas_metal', email: 'info@demirtasmetal.com', company: 'Demirta≈ü Metal San. Tic. Ltd. ≈ûti.', category: 'Metal,√áelik'},
        {username: 'yilmaz_muhendislik', email: 'satƒ±≈ü@yilmaz.com', company: 'Yƒ±lmaz M√ºhendislik A.≈û.', category: 'Makine,Yedek Par√ßa'},
        {username: 'atlas_kimya', email: 'teklif@atlaskimya.com', company: 'Atlas Kimya San. Tic. A.≈û.', category: 'Kimyasal,Boyar Madde'}
    ];

    testSuppliers.forEach((supplier, index) => {
        db.run(`INSERT OR IGNORE INTO users (username, email, password_hash, role, is_active, email_verified) 
                VALUES (?, ?, ?, ?, ?, ?)`, 
            [supplier.username, supplier.email, supplierPassword, 'supplier', 1, 1], 
            function(err) {
                if (err) console.error(`‚ùå ${supplier.username}:`, err.message);
                else {
                    console.log(`‚úÖ ${supplier.username} tedarik√ßi kullanƒ±cƒ± olu≈üturuldu`);
                    
                    // Tedarik√ßi profili ekle
                    db.run(`INSERT OR IGNORE INTO suppliers (user_id, company_name, categories, is_approved, rating) 
                            VALUES (?, ?, ?, ?, ?)`, 
                        [this.lastID, supplier.company, supplier.category, 1, 4.5], 
                        function(err) {
                            if (err) console.error(`‚ùå ${supplier.company} profil:`, err.message);
                            else console.log(`‚úÖ ${supplier.company} profil olu≈üturuldu`);
                        }
                    );
                }
            }
        );
    });

    // Kategoriler ekle
    const categories = [
        'Metal ƒ∞≈üleri', 'Makine Par√ßalarƒ±', 'Kimyasal Maddeler', 'Elektrik Malzemeleri',
        'ƒ∞n≈üaat Malzemeleri', 'Ofis Malzemeleri', 'G√ºvenlik Ekipmanlarƒ±', 'Temizlik Malzemeleri'
    ];

    categories.forEach(category => {
        db.run(`INSERT OR IGNORE INTO categories (name) VALUES (?)`, [category], (err) => {
            if (err) console.error(`‚ùå Kategori ${category}:`, err.message);
            else console.log(`‚úÖ Kategori eklendi: ${category}`);
        });
    });

    // Sistem ayarlarƒ±
    const settings = [
        {key: 'company_name', value: 'TMI Teknoloji', description: '≈ûirket Adƒ±'},
        {key: 'company_email', value: 'info@tmitek.com', description: '≈ûirket Email'},
        {key: 'default_quotation_validity', value: '30', type: 'number', description: 'Varsayƒ±lan Teklif Ge√ßerlilik S√ºresi (G√ºn)'},
        {key: 'auto_approval_suppliers', value: 'false', type: 'boolean', description: 'Tedarik√ßi Otomatik Onay'},
        {key: 'email_notifications', value: 'true', type: 'boolean', description: 'Email Bildirimleri Aktif'},
        {key: 'system_currency', value: 'TRY', description: 'Sistem Para Birimi'}
    ];

    settings.forEach(setting => {
        db.run(`INSERT OR IGNORE INTO settings (key, value, description, type) VALUES (?, ?, ?, ?)`, 
            [setting.key, setting.value, setting.description, setting.type || 'string'], 
            (err) => {
                if (err) console.error(`‚ùå Ayar ${setting.key}:`, err.message);
                else console.log(`‚úÖ Sistem ayarƒ±: ${setting.key} = ${setting.value}`);
            }
        );
    });

    setTimeout(() => {
        console.log('\n‚úÖ VERƒ∞TABANI KURULUMU TAMAMLANDI!');
        console.log('\nüìã OLU≈ûTURULAN TABLOLAR:');
        console.log('   ‚Ä¢ users (Kullanƒ±cƒ±lar)');
        console.log('   ‚Ä¢ suppliers (Tedarik√ßiler)');  
        console.log('   ‚Ä¢ requests (Talepler)');
        console.log('   ‚Ä¢ request_items (Talep Malzemeleri)');
        console.log('   ‚Ä¢ request_suppliers (Talep-Tedarik√ßi ƒ∞li≈ükisi)');
        console.log('   ‚Ä¢ quotations (Teklifler)');
        console.log('   ‚Ä¢ quotation_items (Teklif Malzemeleri)');
        console.log('   ‚Ä¢ categories (Kategoriler)');
        console.log('   ‚Ä¢ notifications (Bildirimler)');
        console.log('   ‚Ä¢ files (Dosyalar)');
        console.log('   ‚Ä¢ settings (Ayarlar)');
        console.log('   ‚Ä¢ audit_logs (ƒ∞≈ülem Ge√ßmi≈üi)');
        
        console.log('\nüë• TEST KULLANICILARI:');
        console.log('   ‚Ä¢ admin / admin123 (Admin)');
        console.log('   ‚Ä¢ demirtas_metal / supplier123 (Tedarik√ßi)');
        console.log('   ‚Ä¢ yilmaz_muhendislik / supplier123 (Tedarik√ßi)');
        console.log('   ‚Ä¢ atlas_kimya / supplier123 (Tedarik√ßi)');
        
        console.log('\nüöÄ Sunucuyu ba≈ülatmak i√ßin: npm start');
        
        db.close();
    }, 2000);
}